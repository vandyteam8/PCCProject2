---
#
# EECS 4287/5287: Principles of Cloud Computing
# Author: Aniruddha Gokhale
# Created: Fall 2016
# Modified: Fall 2020
#
# This playbook will install some packages on cloud VM
# Our cloud can be Horizon Cloud VM or Chameleon VMs or AWS VMs
- hosts: MyChameleonVMs  # machines on whom the action is performed
  gather_facts: yes
  remote_user:  cc    # change username depending on what it is on the cloud
  collections:   # this is new starting with Ansible 2.9 (akin to importing package)
    - openstack.cloud

  tasks:
  - name: Install python3-kafka
    apt: name=python3-kafka state=latest
    become: yes

  - name: Install python3-requests
    apt: name=python3-requests state=latest
    become: yes

  - name: Install git
    apt: name=git state=latest
    become: yes

  - name: Install default-jre (Java)
    apt: name=default-jre state=latest
    become: yes

  - name: Cloning project from github
    command: git clone https://github.com/vandyteam8/PCCProject1.git

  - name: Downloading Kafka tar
    command: wget https://downloads.apache.org/kafka/2.6.0/kafka_2.13-2.6.0.tgz

  - name: Unzipping Kafka tar
    command: tar -xzf kafka_2.13-2.6.0.tgz

  - name: Generating brokerid
    set_fact:
      r: "{{ 100 | random }}"
    run_once: yes

  - name: Replace Kafka brokerid with unique number
    lineinfile:
       dest: ~/kafka_2.13-2.6.0/config/server.properties
       regexp: broker.id=0
       line: broker.id={{r}}
       state: present

  - name: Remove comment on listers
    lineinfile:
        dest: ~/kafka_2.13-2.6.0/config/server.properties
	regexp: #listeners=PLAINTEXT://:9092
	line: listeners=PLAINTEXT://:9092
	state: present

  - name: Storing IP address
    set_fact:
      ipaddress: "{{hostvars[inventory_hostname]['ansible_default_ipv4']['address']}}" #"{{hostvars[inventory_hostname]['ansible_env'].SSH_CONNECTION.split(' ')[2]}}"
    run_once: yes

  - name: Replace IP address
    lineinfile:
        dest: ~/kafka_2.13-2.6.0/config/server.properties
        regexp: advertised.listeners=PLAINTEXT://your.host.name:9092
        line: advertised.listeners=PLAINTEXT://{{ipaddress}}:9092
        state: present

  - name: Replace Zookeeper IP address
    lineinfile:
        dest: ~/kafka_2.13-2.6.0/config/server.properties
        regexp: zookeeper.connect=localhost:2181
        line: zookeeper.connect={{ipaddress}}:2181
        state: present

  - include: playbook_zookeeper.yml
    when: "'zookeeper' in {{MyZookeeperVM}}"
    
  - name: Start kafka
    command: kafka*/bin/kafka-server-start.sh config/server.properties &

  - name: Subscribe to kafka topics utilizations1
    command: kafka*/bin/kafka-topics.sh --zookeeper 54.145.170.98:2181 --create --topic utilizations1 --partitions 3 --replication-factor 2 &

  - name: Subscribe to kafka topics utilizations2
    command: kafka*/bin/kafka-topics.sh --zookeeper 54.145.170.98:2181 --create --topic utilizations2 --partitions 3 --replication-factor 2

  - name: Subscrive to kafka topic utilizations3
    command: kafka*/bin/kafka-topics.sh --zookeeper 54.145.170.98:2181 --create --topic utilizations1 --partitions 3 --replication-factor 2



  - include: playbook_couchdb.yml
    when: "'zookeeper' in {{MyCouchDBVM}}"



...

